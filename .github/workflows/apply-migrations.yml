name: Apply DB migrations

on:
  workflow_dispatch:

jobs:
  apply-migrations:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Verify migrations directory
        run: |
          if [ ! -d "supabase/migrations" ]; then
            echo "Error: supabase/migrations directory not found"
            exit 1
          fi
          echo "Found $(ls -1 supabase/migrations/*.sql 2>/dev/null | \
            wc -l) migration files"

      - name: Link to Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "Error: SUPABASE_ACCESS_TOKEN secret is not set"
            echo "Please add SUPABASE_ACCESS_TOKEN to your repository secrets"
            echo "Get it from: https://supabase.com/dashboard/account/tokens"
            exit 1
          fi

          # Read project ID from config.toml
          PROJECT_ID=$(grep -m 1 'project_id' supabase/config.toml | \
            cut -d '"' -f 2)

          if [ -z "$PROJECT_ID" ]; then
            echo "Error: Could not find project_id in supabase/config.toml"
            exit 1
          fi

          echo "Linking to Supabase project: $PROJECT_ID"
          supabase link --project-ref "$PROJECT_ID"

      - name: Apply migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "Applying migrations to database..."
          echo "This will apply all pending migrations from" \
            "supabase/migrations/"

          # Show migration status
          echo "Checking migration status..."
          supabase migration list || echo "Could not fetch migration status"

          # Apply all pending migrations
          echo "Applying migrations..."
          supabase db push

          echo "All migrations applied successfully!"

      - name: Verify migrations
        run: |
          echo "Migration application completed"
          echo "Please verify in your Supabase dashboard:"
          echo "1. Check Database → Tables for new tables/columns"
          echo "2. Check Database → Policies for RLS policies"
          echo "3. Test with anon key to verify RLS enforcement"

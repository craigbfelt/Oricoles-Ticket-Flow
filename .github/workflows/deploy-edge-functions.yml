name: Deploy Edge Functions

# This workflow deploys Supabase Edge Functions when function files change
# Edge functions are serverless functions that run on Supabase infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - 'supabase/functions/**'
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'Deploy all functions (not just changed ones)'
        required: false
        type: boolean
        default: false
      function_name:
        description: 'Deploy specific function (leave empty for all)'
        required: false
        type: string
        default: ''

# Limit permissions to minimum required
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  deploy-edge-functions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Verify Supabase CLI installation
        run: supabase --version

      - name: Link to Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          PROJECT_ID=$(grep -m 1 'project_id' supabase/config.toml | cut -d '"' -f 2)
          echo "Project ID: $PROJECT_ID"
          supabase link --project-ref $PROJECT_ID --password "$SUPABASE_DB_PASSWORD"

      - name: Detect changed functions
        id: detect
        if: ${{ !inputs.deploy_all && inputs.function_name == '' }}
        run: |
          # Get list of changed function directories
          CHANGED_FUNCTIONS=$(git diff --name-only HEAD~1 HEAD -- supabase/functions/ | \
            grep -oP 'supabase/functions/\K[^/]+' | \
            grep -v '^_shared$' | \
            sort -u | \
            tr '\n' ' ')
          
          echo "Changed functions: $CHANGED_FUNCTIONS"
          echo "functions=$CHANGED_FUNCTIONS" >> $GITHUB_OUTPUT
          
          # Check if _shared folder changed (affects all functions)
          if git diff --name-only HEAD~1 HEAD -- supabase/functions/_shared/ | grep -q .; then
            echo "shared_changed=true" >> $GITHUB_OUTPUT
          else
            echo "shared_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy all functions
        if: ${{ inputs.deploy_all || steps.detect.outputs.shared_changed == 'true' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "[DEPLOY] Deploying ALL edge functions..."
          
          # Get list of all function directories (excluding _shared)
          FUNCTIONS=$(ls -d supabase/functions/*/ 2>/dev/null | \
            xargs -I {} basename {} | \
            grep -v '^_shared$' | \
            tr '\n' ' ')
          
          echo "Functions to deploy: $FUNCTIONS"
          
          DEPLOYED=0
          FAILED=0
          
          for func in $FUNCTIONS; do
            echo "Deploying function: $func"
            if supabase functions deploy "$func" --no-verify-jwt=false; then
              echo "‚úÖ Successfully deployed: $func"
              DEPLOYED=$((DEPLOYED + 1))
            else
              echo "‚ùå Failed to deploy: $func"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo "DEPLOYED=$DEPLOYED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          
          if [ $FAILED -gt 0 ]; then
            echo "‚ö†Ô∏è Some functions failed to deploy"
            exit 1
          fi

      - name: Deploy specific function
        if: ${{ inputs.function_name != '' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          FUNC="${{ inputs.function_name }}"
          echo "[DEPLOY] Deploying specific function: $FUNC"
          
          if [ -d "supabase/functions/$FUNC" ]; then
            if supabase functions deploy "$FUNC" --no-verify-jwt=false; then
              echo "‚úÖ Successfully deployed: $FUNC"
              echo "DEPLOYED=1" >> $GITHUB_ENV
              echo "FAILED=0" >> $GITHUB_ENV
            else
              echo "‚ùå Failed to deploy: $FUNC"
              echo "DEPLOYED=0" >> $GITHUB_ENV
              echo "FAILED=1" >> $GITHUB_ENV
              exit 1
            fi
          else
            echo "‚ùå Function directory not found: supabase/functions/$FUNC"
            exit 1
          fi

      - name: Deploy changed functions only
        if: ${{ !inputs.deploy_all && inputs.function_name == '' && steps.detect.outputs.shared_changed != 'true' && steps.detect.outputs.functions != '' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          FUNCTIONS="${{ steps.detect.outputs.functions }}"
          echo "[DEPLOY] Deploying changed functions: $FUNCTIONS"
          
          DEPLOYED=0
          FAILED=0
          
          for func in $FUNCTIONS; do
            echo "Deploying function: $func"
            if supabase functions deploy "$func" --no-verify-jwt=false; then
              echo "‚úÖ Successfully deployed: $func"
              DEPLOYED=$((DEPLOYED + 1))
            else
              echo "‚ùå Failed to deploy: $func"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo "DEPLOYED=$DEPLOYED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          
          if [ $FAILED -gt 0 ]; then
            echo "‚ö†Ô∏è Some functions failed to deploy"
            exit 1
          fi

      - name: No functions to deploy
        if: ${{ !inputs.deploy_all && inputs.function_name == '' && steps.detect.outputs.shared_changed != 'true' && steps.detect.outputs.functions == '' }}
        run: |
          echo "No function changes detected. Skipping deployment."
          echo "DEPLOYED=0" >> $GITHUB_ENV
          echo "FAILED=0" >> $GITHUB_ENV

      - name: Deployment Summary
        if: always()
        run: |
          echo "## üöÄ Edge Functions Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Deployed | ${DEPLOYED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | ${FAILED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Edge Functions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -d supabase/functions/*/ 2>/dev/null | xargs -I {} basename {} | grep -v '^_shared$' | while read func; do
            echo "- \`$func\`" >> $GITHUB_STEP_SUMMARY
          done

      - name: Comment on commit (on success)
        if: success() && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha;
            const deployed = process.env.DEPLOYED || '0';
            const message = `‚úÖ **Edge Functions deployed successfully!**\n\n${deployed} function(s) deployed to Supabase.`;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body: message
            });

      - name: Comment on commit (on failure)
        if: failure() && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha;
            const failed = process.env.FAILED || '0';
            const message = `‚ùå **Edge Functions deployment failed!**\n\n${failed} function(s) failed to deploy.\n\nPlease check the workflow logs for details.\n\n[View Workflow Run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body: message
            });

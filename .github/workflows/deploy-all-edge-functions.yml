name: Deploy All Edge Functions

# This workflow deploys ALL edge functions to Supabase.
# Use this for initial setup or when you need to force a full deployment.
# For normal operations, use deploy-changed-edge-functions.yml which only deploys changed functions.

on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "deploy" to confirm deployment of all edge functions'
        required: true
        default: ''

jobs:
  deploy-all:
    runs-on: ubuntu-latest
    # Only run if the user confirmed by typing "deploy"
    if: github.event.inputs.confirm_deployment == 'deploy'
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Configure Supabase CLI
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Link to Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          # Get project ID from config.toml if SUPABASE_PROJECT_REF is not set
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            PROJECT_ID=$(grep -m 1 'project_id' supabase/config.toml | cut -d '"' -f 2)
          else
            PROJECT_ID="$SUPABASE_PROJECT_REF"
          fi
          
          echo "Linking to Supabase project: $PROJECT_ID"
          supabase link --project-ref "$PROJECT_ID"

      - name: Get list of edge functions
        id: functions
        run: |
          # Find all directories under supabase/functions that contain an index.ts file
          # Exclude the _shared directory
          FUNCTIONS=$(find supabase/functions -maxdepth 2 -name "index.ts" -type f | \
            sed 's|supabase/functions/||' | \
            sed 's|/index.ts||' | \
            grep -v "^_shared$" | \
            sort)
          
          echo "Found edge functions:"
          echo "$FUNCTIONS"
          
          # Convert to space-separated string
          FUNC_LIST=$(echo "$FUNCTIONS" | tr '\n' ' ')
          echo "functions=$FUNC_LIST" >> $GITHUB_OUTPUT

      - name: Deploy all edge functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Deploying all edge functions..."
          
          FAILED=""
          SUCCEEDED=""
          
          for fn in ${{ steps.functions.outputs.functions }}; do
            echo ""
            echo "=========================================="
            echo "Deploying: $fn"
            echo "=========================================="
            
            if supabase functions deploy "$fn" --no-verify-jwt=false; then
              echo "✅ Successfully deployed: $fn"
              SUCCEEDED="$SUCCEEDED $fn"
            else
              echo "❌ Failed to deploy: $fn"
              FAILED="$FAILED $fn"
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo "✅ Succeeded:$SUCCEEDED"
          
          if [ -n "$FAILED" ]; then
            echo "❌ Failed:$FAILED"
            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Edge Functions Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All edge functions have been deployed to Supabase." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Functions deployed:**" >> $GITHUB_STEP_SUMMARY
          for fn in ${{ steps.functions.outputs.functions }}; do
            echo "- $fn" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify functions are working by visiting your Supabase dashboard" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure any required environment variables in Supabase" >> $GITHUB_STEP_SUMMARY

  confirmation-missing:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_deployment != 'deploy'
    steps:
      - name: Confirmation missing
        run: |
          echo "❌ Deployment cancelled: You must type 'deploy' to confirm."
          echo ""
          echo "This is a safety measure to prevent accidental deployments."
          echo "To deploy all edge functions, run this workflow again and type 'deploy' in the confirmation field."
          exit 1
